<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¬Ø¯ - Ø±ÙÙŠÙ‚ Ø§Ù„Ù…Ø³Ù„Ù…</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #2ecc71;
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 0.9em;
        }

        .controls {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .search-box:focus {
            outline: none;
            border-color: #2ecc71;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-refresh {
            background: #3498db;
            color: white;
        }

        .btn-refresh:hover {
            background: #2980b9;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .device-id {
            font-family: monospace;
            background: #ecf0f1;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-edit {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2ecc71;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-save {
            flex: 1;
            background: #2ecc71;
            color: white;
        }

        .btn-cancel {
            flex: 1;
            background: #95a5a6;
            color: white;
        }

        .btn-save:hover {
            background: #27ae60;
        }

        .btn-cancel:hover {
            background: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ•Œ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¬Ø¯</h1>
            <p>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† - Ø±ÙÙŠÙ‚ Ø§Ù„Ù…Ø³Ù„Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalMosques">0</h3>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§Ø¬Ø¯</p>
            </div>
            <div class="stat-card">
                <h3 id="totalDevices">0</h3>
                <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</p>
            </div>
            <div class="stat-card">
                <h3 id="todayMosques">0</h3>
                <p>Ù…Ø¶Ø§ÙØ© Ø§Ù„ÙŠÙˆÙ…</p>
            </div>
        </div>

        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³Ø¬Ø¯...">
            <button class="btn btn-refresh" onclick="loadMosques()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            <table id="mosquesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¬Ø¯</th>
                        <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                        <th>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</th>
                        <th>Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="mosquesBody">
                </tbody>
            </table>
            <div id="emptyState" class="empty-state" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z" />
                </svg>
                <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¬Ø¯ Ù…Ø¶Ø§ÙØ©</h3>
                <p>Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¬Ø¯ Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ø¯</h2>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¬Ø¯</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" id="editAddress">
            </div>
            <div class="modal-actions">
                <button class="btn btn-save" onclick="saveMosque()">ğŸ’¾ Ø­ÙØ¸</button>
                <button class="btn btn-cancel" onclick="closeModal()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://kghwboxevphvxtsagrer.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtnaHdib3hldnBodnh0c2FncmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1MzE4NzQsImV4cCI6MjA1MDEwNzg3NH0.sb_publishable_Kl3FXiXa7AHEokVvCiImmQ_03UL91M0';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allMosques = [];
        let currentEditId = null;

        async function loadMosques() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('mosquesTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            try {
                const { data, error } = await supabase
                    .from('user_mosques')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allMosques = data || [];
                updateStats();
                displayMosques(allMosques);
            } catch (error) {
                console.error('Error loading mosques:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateStats() {
            const total = allMosques.length;
            const devices = new Set(allMosques.map(m => m.device_id)).size;
            const today = allMosques.filter(m => {
                const created = new Date(m.created_at);
                const now = new Date();
                return created.toDateString() === now.toDateString();
            }).length;

            document.getElementById('totalMosques').textContent = total;
            document.getElementById('totalDevices').textContent = devices;
            document.getElementById('todayMosques').textContent = today;
        }

        function displayMosques(mosques) {
            const tbody = document.getElementById('mosquesBody');
            tbody.innerHTML = '';

            if (mosques.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            document.getElementById('mosquesTable').style.display = 'table';

            mosques.forEach(mosque => {
                const row = document.createElement('tr');
                const deviceId = mosque.device_id || 'unknown';
                const shortDeviceId = deviceId.substring(0, 8);
                const date = new Date(mosque.created_at).toLocaleDateString('ar-EG');

                row.innerHTML = `
                    <td><strong>${mosque.name}</strong></td>
                    <td>${mosque.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td style="font-size: 0.85em;">${mosque.latitude.toFixed(6)}, ${mosque.longitude.toFixed(6)}</td>
                    <td><span class="device-id">${shortDeviceId}</span></td>
                    <td>${date}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-edit" onclick="editMosque('${mosque.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-delete" onclick="deleteMosque('${mosque.id}', '${mosque.name}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editMosque(id) {
            const mosque = allMosques.find(m => m.id === id);
            if (!mosque) return;

            currentEditId = id;
            document.getElementById('editName').value = mosque.name;
            document.getElementById('editAddress').value = mosque.address || '';
            document.getElementById('editModal').classList.add('active');
        }

        async function saveMosque() {
            const name = document.getElementById('editName').value.trim();
            const address = document.getElementById('editAddress').value.trim();

            if (!name) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¬Ø¯');
                return;
            }

            try {
                const { error } = await supabase
                    .from('user_mosques')
                    .update({ name, address })
                    .eq('id', currentEditId);

                if (error) throw error;

                alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­ âœ…');
                closeModal();
                loadMosques();
            } catch (error) {
                console.error('Error updating mosque:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
            }
        }

        async function deleteMosque(id, name) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù "${name}"ØŸ\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('user_mosques')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…');
                loadMosques();
            } catch (error) {
                console.error('Error deleting mosque:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditId = null;
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allMosques.filter(m =>
                m.name.toLowerCase().includes(query) ||
                (m.address && m.address.toLowerCase().includes(query))
            );
            displayMosques(filtered);
        });

        // Load on page load
        loadMosques();
    </script>
</body>

</html>